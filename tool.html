<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>외국인 비자 사건 수임 분석 시스템 v2.1</title>

<style>
:root {
    --primary:#1a252f;
    --secondary:#34495e;
    --accent:#c0392b;
    --success:#27ae60;
    --bg:#ecf0f1;
}
body{
    margin:0;
    font-family:"Malgun Gothic","Pretendard",sans-serif;
    background:var(--bg);
    display:flex;
    justify-content:center;
    padding:20px;
}
.container{
    width:100%;
    max-width:720px;
    background:#fff;
    border-radius:12px;
    box-shadow:0 15px 40px rgba(0,0,0,.15);
    overflow:hidden;
}
.header{
    background:var(--primary);
    color:#fff;
    padding:25px;
    text-align:center;
}
.header h2{margin:0;font-size:1.6rem}
.header p{margin:6px 0 0;font-size:.9rem;opacity:.85}

.content{padding:30px}
.form-group{margin-bottom:18px}
.form-group label{
    display:block;
    margin-bottom:6px;
    font-weight:bold;
    color:var(--secondary);
}
input,select{
    width:100%;
    padding:12px;
    border:1px solid #ddd;
    border-radius:6px;
    font-size:1rem;
}
input:focus,select:focus{
    outline:none;
    border-color:var(--primary);
}
.row{display:flex;gap:14px}
.col{flex:1}

button{
    width:100%;
    padding:15px;
    background:var(--primary);
    color:#fff;
    border:none;
    border-radius:6px;
    font-size:1.05rem;
    font-weight:bold;
    cursor:pointer;
    margin-top:10px;
}
button:hover{background:#243544}

#status-log{
    margin-top:18px;
    background:#111;
    color:#0f0;
    padding:12px;
    font-family:monospace;
    font-size:.85rem;
    border-radius:6px;
    display:none;
    max-height:160px;
    overflow-y:auto;
}

#result-box{
    margin-top:22px;
    border:1px solid #ddd;
    border-radius:8px;
    display:none;
}
#result-header{
    background:#f4f6f7;
    padding:14px;
    font-weight:bold;
    color:var(--primary);
    border-bottom:1px solid #ddd;
}
#result-content{
    padding:22px;
    line-height:1.7;
    white-space:pre-wrap;
}

.footer{
    text-align:center;
    font-size:.8rem;
    color:#777;
    padding:14px;
}
.badge-success{color:var(--success);font-weight:bold}
</style>
</head>

<body>
<div class="container">

<div class="header">
    <h2>외국인 비자 사건 수임 분석 시스템</h2>
    <p>Law Firm AI · 체류자격 변경 정밀 분석</p>
</div>

<div class="content">

<!-- API KEY -->
<div class="form-group">
<label>Google Gemini API Key</label>
<input type="password" id="apiKey" placeholder="AIzaSy...">
<label style="font-size:.85rem;">
<input type="checkbox" id="saveKey"> 이 브라우저에 API Key 저장
</label>
</div>

<hr>

<!-- FILE UPLOAD -->
<div class="form-group">
<label>?? 출입국 매뉴얼 PDF 업로드</label>
<input type="file" id="pdfFile" accept="application/pdf">
<button onclick="uploadPdf()">PDF 업로드</button>
<div id="fileStatus" style="font-size:.85rem;margin-top:6px;"></div>
</div>

<hr>

<!-- INPUT ZONE -->
<div class="row">
<div class="col form-group">
<label>현재 비자</label>
<input id="visaType" value="E-9">
</div>
<div class="col form-group">
<label>나이 / 생년</label>
<input id="age" value="1994년생 (31세)">
</div>
</div>

<div class="row">
<div class="col form-group">
<label>연간 소득 (만원)</label>
<input type="number" id="income" value="3400">
</div>
<div class="col form-group">
<label>한국어 능력</label>
<select id="korean">
<option>없음</option>
<option>1급</option>
<option>2급</option>
<option selected>3급</option>
<option>4급</option>
<option>5급 이상</option>
<option>사회통합 4단계</option>
<option>사회통합 5단계</option>
</select>
</div>
</div>

<div class="form-group">
<label>기타 특이사항</label>
<input id="details" value="국내 지방대 졸업">
</div>

<button onclick="runAnalysis()">AI 분석 실행</button>

<div id="status-log"></div>

<div id="result-box">
<div id="result-header">AI 분석 결과</div>
<div id="result-content"></div>
</div>

</div>

<div class="footer">
    법무법인 대림 · 사무장 이규희<br>
    Version 2.1 (Gemini File API 기반)
</div>

</div>

<script>
let uploadedFileUri = null;

window.onload = () => {
    const k = localStorage.getItem("geminiKey");
    if(k){
        apiKey.value = k;
        saveKey.checked = true;
    }
};

function log(msg){
    const box = document.getElementById("status-log");
    box.style.display="block";
    box.innerHTML += "> " + msg + "\n";
    box.scrollTop = box.scrollHeight;
}

/* STEP 1 : PDF UPLOAD */
async function uploadPdf(){
    const key = apiKey.value.trim();
    const file = pdfFile.files[0];
    if(!key) return alert("API Key를 입력하세요.");
    if(!file) return alert("PDF 파일을 선택하세요.");

    log("PDF 업로드 중...");

    try{
        const res = await fetch(
            "https://generativelanguage.googleapis.com/upload/v1beta/files?key="+key,
            {
                method:"POST",
                headers:{
                    "X-Goog-Upload-Protocol":"raw",
                    "Content-Type":"application/pdf"
                },
                body:file
            }
        );
        const data = await res.json();
        if(data.file && data.file.uri){
            uploadedFileUri = data.file.uri;
            fileStatus.innerHTML =
                "업로드 완료: <span class='badge-success'>" + uploadedFileUri + "</span>";
            log("파일 URI 저장 완료");
        }else{
            throw new Error("업로드 실패");
        }
    }catch(e){
        alert("파일 업로드 오류");
        log("ERROR: "+e.message);
    }
}

/* STEP 2 : ANALYSIS */
async function runAnalysis(){
    if(!uploadedFileUri) return alert("먼저 PDF를 업로드하세요.");
    const key = apiKey.value.trim();
    if(!key) return alert("API Key 누락");

    if(saveKey.checked) localStorage.setItem("geminiKey",key);
    else localStorage.removeItem("geminiKey");

    result-box.style.display="none";
    status-log.innerHTML="";
    log("AI 분석 요청 중...");

    const prompt = `
당신은 대한민국의 유능한 출입국 전문 행정/법률 사무장입니다.
업로드된 매뉴얼(PDF)을 최우선 근거로 하여
의뢰인의 F-2-R, E-7-4, F-2-7 비자 변경 가능성을 분석하세요.

[의뢰인 정보]
- 현재비자: ${visaType.value}
- 나이: ${age.value}
- 소득: ${income.value}만원
- 한국어: ${korean.value}
- 기타: ${details.value}

[출력]
1. 비자별 가능성 분석
2. 1·2·3순위 전략
3. 실무상 주의사항
`;

    try{
        const res = await fetch(
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key="+key,
            {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({
                    contents:[{
                        parts:[
                            { text: prompt },
                            { file_data:{ file_uri: uploadedFileUri } }
                        ]
                    }]
                })
            }
        );
        const data = await res.json();
        const text = data.candidates[0].content.parts[0].text;
        result-content.innerHTML = markdown(text);
        result-box.style.display="block";
        status-log.style.display="none";
    }catch(e){
        alert("분석 실패");
        log("ERROR: "+e.message);
    }
}

function markdown(t){
    return t.replace(/\*\*(.*?)\*\*/g,"<b>$1</b>").replace(/\n/g,"<br>");
}
</script>

</body>
</html>
